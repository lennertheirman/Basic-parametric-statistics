---
title: "FSS 2025 Basic Parametric Statistics Session 1"
author: "Lennert Heirman"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    number_sections: true
---
# Set up
```{r}
setwd("C:/R_Projects/Flames summer school 2025/Basic parametric statistics/Session 1")

library(ggplot2)
library(lattice)
```

# Import Data Set
```{r}
library(readr)
tbad <- read.delim("TBAD.txt")
head(tbad)
View(tbad)
str(tbad)
```

# Structure data and do transformations
```{r}
tbad$Secondary.specialty<-factor(tbad$Secondary.specialty,
 levels=0:1,labels=c("no","yes"))
tbad$Certification.level<-factor(tbad$Certification.level)
tbad$Gender=factor(tbad$Gender,
 levels=0:1,labels=c("man","woman"))
tbad$Medical.school<-factor(tbad$Medical.school,
 levels=0:1,labels=c("USA","Foreign"))
tbad$Residence<-factor(tbad$Residence,
 levels=0:1,labels=c("USA","Foreign"))
str(tbad)
tbad$Specialty <- as.factor(tbad$Specialty)
attach(tbad)
```

# Exploratory Analysis

# Categorical variables
```{r}
# Frequency tables and plots for nominal/ordinal data:
tab<-table(Specialty)
tabp<-prop.table(tab)
ft <- rbind(tab, tabp, cumsum(tab), cumsum(tabp))			
# The cumulatives are given so you know how to do it, 
# but are of course only of interest 
# when you work with ordinal data
ft2<- t(ft)  #transport data (columns become rows)
colnames(ft2) <- c("freq","percent",
                  "cumul freq","cumul percent")
round(ft2, 2)  #only 2 decimals

barplot(tab,main="Barplot for Specialty", 
 xlab="Specialty", ylab="Frequency",ylim=c(0,70))

barplot(tab,main="Barplot for Specialty", 
 xlab="Frequency", ylab="Specialty",xlim=c(0,60),horiz=T,col="orange")

pie(tab,main="Pie chart for Specialty",col=1:7)

# Create percentages on piechart solution ChatGPT
pct <- round(tab / sum(tab) * 100)
labels <- paste(names(tab), pct, "%")
pie(tab,
    labels = labels,
    main = "Pie chart for Specialty",
    col = 1:7)

# create perentages on piechart solution in lesson through google
library(lessR)
cat <- data.frame(Specialty)
cols <-  hcl.colors(length(levels(Specialty)), "Fall")
PieChart(Specialty, data = tbad, hole = 0,
         fill = cols,
         labels_cex = 0.6)
```

# Numerical data
```{r}
# Histogram
hist(tbad$Years.of.experience,main="",
 xlab="Experience (years)",
 ylab="Frequency",col="blue");box()
 # optional
 hist(tbad$Years.of.experience,main="",
  xlab="Experience (years)",
  ylab="Frequency",col="blue",
  breaks=20);box()
 
  hist(tbad$Years.of.experience,main="",
  xlab="Experience (years)",
  ylab="Frequency",col="lightblue",
  breaks=20,probability = T)
  lines(density(Years.of.experience),col="red",lwd=2)
  
  histogram(~Years.of.experience|Specialty)
  
  boxplot(Years.of.experience)
  text(1,mean(Years.of.experience),"*",cex=1.6,col="red")
  
  
# Summary numbers for location, spread
summary(tbad$Years.of.experience)

 # Central tendency
  # Calculate mean of variable:
 mean(tbad$Years.of.experience)		
  # Calculate median of variable:
 median(tbad$Years.of.experience)		
  # Calculate mode of variable
  # Table needed to calculate mode: (not of primary interest)
 tab<-table(tbad$Years.of.experience)	
 as.numeric(names(tab)[tab==max(tab)])	
 
  # Spread
  # Calculate range of variable:
 max(tbad$Years.of.experience)-min(tbad$Years.of.experience)	#range
  # Calculate standard deviation of variable:
 var(tbad$Years.of.experience)	
 sd(tbad$Years.of.experience)	 	
  # Calculate inter quartile range of variable: 
  # several algorithms to calculate quantiles 
  # (see help(IQR) to choose type)
  # e.g. type=6 for SPSS-like IQR
 IQR(tbad$Years.of.experience)		
 IQR(tbad$Years.of.experience,type=6)  #different types of IQR

```

## Relative standings
```{r}
boxplot(log(Total.average.costs.per.patient.per.month))  #IQR*1.5, then you add that to upper quartile, points above that are potential outliers, you remove them from analysis, do analysis and look if there are different outcomes, then you include both analysis (not remove outliers because potential values)
hist(Total.average.costs.per.patient.per.month)
# Relative standing and outliers
 average<-mean(tbad$Total.average.costs.per.patient.per.month)
 s<-sd(tbad$Total.average.costs.per.patient.per.month)
  ## Empirical rule:
  # Interval containing about 70% of the data (actually 68%)
  # (in unimodal, symmetric case)
 c(average-s,average+s)			
  # Interval containing about 95% of the data 
  # (in unimodal, symmetric case)
 c(average-2*s,average+2*s)			
  # Interval containing about 99% of the data 
  # (in unimodal, symmetric case)
 c(average-3*s,average+3*s)			

 hist(tbad$Total.average.costs.per.patient.per.month,
  main="Histogram of average cost per month",
  xlab="Total average cost per month",
  ylab="Frequency")

  # Calculate 1st quantile:
 Q1<-quantile(tbad$Total.average.costs.per.patient.per.month,
  probs=0.25)		
  # Calculate 2nd quantile:
  # median(tbad$Total.average.costs.per.patient.per.month) #OR
 Q2<-quantile(tbad$Total.average.costs.per.patient.per.month,
  probs=0.5)		
  # Calculate 3rd quantile:
 Q3<-quantile(tbad$Total.average.costs.per.patient.per.month,
  probs=0.75)	
  # calculate all at once
 quantile(tbad$Total.average.costs.per.patient.per.month,
  probs=c(0.25,0.5,0.75))
 
  ## Boxplot rule:
  # Interval that captures exactly 50% of the data:
 c(Q1,Q3)															
  # Interval that captures about 95% of the data:
 c(Q2-1.5*IQR(tbad$Total.average.costs.per.patient.per.month),
  Q2+1.5*IQR(tbad$Total.average.costs.per.patient.per.month))	
  # Interval that captures about 99% of the data
 c(Q1-1.5*IQR(tbad$Total.average.costs.per.patient.per.month),
  Q3+1.5*IQR(tbad$Total.average.costs.per.patient.per.month))	

 boxplot(tbad$Total.average.costs.per.patient.per.month,
  main="Boxplot of average cost per month")
  # zoom in on lower part
 boxplot(tbad$Total.average.costs.per.patient.per.month,
  main="Boxplot of average cost per month",
  ylim=c(0,250))
```

## One sample test
```{r}
# For purpose of illustration: select subset of data, containing
# only doctors with specialty Family Practice
costPatientFp<-tbad$Total.average.costs.per.patient.per.month[tbad$Specialty=="fp"]

histogram(costPatientFp)
hist(costPatientFp)
boxplot(costPatientFp)  #skewed to the right
library(e1071)
skewness(costPatientFp)
kurtosis(costPatientFp)

# Read confidence interval and compare with total average cost
t.test(costPatientFp)			

# By default test for mu=0
# Add argument to perform t-test for mu=103  
t.test(costPatientFp,mu=103)	
# By default test is two-sided				
# Add argument to perform one-sided test
t.test(costPatientFp,mu=103,alternative='less')		
# Note that confidence interval changes!

## A continuous variable over categories
# use ~ to create multiple boxplots
boxplot(tbad$Total.average.costs.per.patient.per.month~tbad$Specialty,
 ylab="Average cost per patient per month")
boxplot(tbad$Total.average.costs.per.patient.per.month~tbad$Specialty,
 ylab="Average cost per patient per month",
 ylim=c(-100,420))  #limit the y axis because outliers make it difficult to really say something about data

# summary numbers computed by category:
tapply(tbad$Total.average.costs.per.patient.per.month, 
 tbad$Specialty, summary)

histogram(~Total.average.costs.per.patient.per.month|Specialty) #everything is skewed

# std. dev. by category:
tapply(tbad$Total.average.costs.per.patient.per.month, 
 tbad$Specialty, sd)

## Two sample inferences: the mean
# Select costs only for doctors who studied in USA
costUSA<-tbad$Total.average.costs.per.patient.per.month[tbad$Medical.school=="USA"]
# Select costs only for doctors who studied in foreign country
costFor<-tbad$Total.average.costs.per.patient.per.month[tbad$Medical.school=="Foreign"]
# Check equality of variances:
# remark difference F-test <-> Levene's test!!! 
# (cfr class 3)
var.test(costUSA,costFor)	
hist(costUSA)
shapiro.test(costUSA)
hist(costFor)
shapiro.test(costFor)
# Change var.equal option, depending on result of variance test
t.test(costUSA,costFor, var.equal=F)

# Select costs only for doctors without secondary specialty
costSecSpec0<-tbad$Total.average.costs.per.patient.per.month[tbad$Secondary.specialty=="no"]
# Select costs only for doctors with secondary specialty
costSecSpec1<-tbad$Total.average.costs.per.patient.per.month[tbad$Secondary.specialty=="yes"]
# Check equality of variances:
# remark difference F-test <-> Levene's test!!! 
# (cfr class 3)
var.test(costSecSpec0,costSecSpec1)
# Change var.equal option, depending on result of variance test
# based on Levene's test (see Part 3) we assume equal variances
t.test(costSecSpec0,costSecSpec1, var.equal=T)		# Change var.equal option, depending on result of variance test

## Paired t-test
measures<-read.table("MEASURES.TXT",sep="\t",header=T) 
# Perform a paired t-test for dependent measures:
t.test(measures$Before,measures$After,paired=T)		
```

# Excercise 1.2
a)	Analyze the frequency table for the variable sex to see that both groups are well represented.
```{r}
library(haven)
BP <- read_sav("BP.sav")
head(BP)
View(BP)

table(BP$Sex)
prop.table(table(BP$Sex))  #is this balanced or not?
barplot(prop.table(table(BP$Sex))) #not really balanced so correct for this

barplot(table(BP$RiskSystolic))
100*prop.table(table(BP$RiskSystolic))
barplot(100*prop.table(table(BP$RiskSystolic)),ylim=c(0,30))

hist(BP$RiskSystolic)
hist(BP$RiskDiastolic)

boxplot(BP$KorotkoffLASys~BP$Sex)
boxplot(BP$KorotkoffLADias~BP$Sex)

boxplot(BP$KorotkoffLASys~BP$RiskSystolic)
boxplot(BP$KorotkoffLADias~BP$RiskDiastolic)


KorLASysF <- BP$KorotkoffLASys[BP$Sex=="F"]
KorLASysF
KorLASysM <- BP$KorotkoffLASys[BP$Sex=="M"]
KorLASysM

hist(KorLASysF)
shapiro.test(KorLASysF)
summary(KorLASysF)

hist(KorLASysM)
shapiro.test(KorLASysM)
Summary(KorLASysM)

var.test(KorLASysF,KorLASysM)
```
b)	How are the patients distributed over the risk categories?
```{r}
barplot(table(BP$RiskSystolic))
100*prop.table(table(BP$RiskSystolic))
barplot(100*prop.table(table(BP$RiskSystolic)),ylim=c(0,30))
```

c)	Explore the boxplot of the Korotkoff scores to check differences among sex.
```{r}
attach(BP)
boxplot(KorotkoffLASys~Sex) #median slightly higher females, IQR seems to be similar, 

tapply(KorotkoffLASys,Sex,hist)
tapply(KorotkoffLASys,Sex,shapiro.test)
lkortosys <- log10(KorotkoffLASys+1)
tapply(lkortosys,Sex,shapiro.test)  #normality holds on a log level
### test for equality of variances
var.test(KorotkoffLASys~Sex)
var.test(lkortosys~Sex)
 #variances are equal, also on log level
t.test(lkortosys~Sex,var.equal=T)  #var.equal bcs variances are equeal, otherwise R uses welch test
    ## not enough evidence to see that they are different


boxplot(KorotkoffLADias~Sex)
tapply(KorotkoffLADias,Sex,hist)
tapply(KorotkoffLADias,Sex,shapiro.test) #normality ok so we dont need to transform

var.test(KorotkoffLADias~Sex) #variances equal
t.test(KorotkoffLADias~Sex,var.equal=T)  #var.equal bcs variances are equeal, otherwise R uses welch test
    ## not enough evidence to see that they are different

##alternatives
wilcox.test(KorotkoffLASys~Sex)
wilcox.test(KorotkoffLADias~Sex)
  #in case of outliers we can go to nonparam as then its more robust and for small samples sizes more robust


```

d)	Explore the boxplot of the Korotkoff scores over the risk groups for a visual analysis.
```{r}
boxplot(BP$KorotkoffLASys~BP$RiskSystolic) #no normality so we cannot talk about mean, we can talk about the median, there is clearly a gradient so we can safely use this risk categorisation
```

f)	Based on the boxplot over the risk categories, do you agree with the risk groups assessment of the physicians? Where would you define the boundaries for a good blood pressure?
g)	Do you agree that the patients do not deviate significantly from their long term mean blood pressure?
```{r}
t.test(KorotkoffLASys,LongTermMeanSys,paired=T)
diffcore=KorotkoffLASys-LongTermMeanSys
diffcore
hist(diffcore)
shapiro.test(diffcore)  #not normally distr

wilcox.test(KorotkoffLASys,LongTermMeanSys,paired=T) #more powerful
```

